<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar - Student Organizer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background-color: #f4f7f6; color: #333; }
        .sidebar { position: fixed; top: 0; left: -250px; width: 250px; height: 100vh; background: #2c3e50; color: white; transition: left 0.3s ease; z-index: 1000; display: flex; flex-direction: column; }
        .sidebar.active { left: 0; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #34495e; }
        .sidebar-header h2 { font-size: 1.5rem; }
        .sidebar-nav { flex: 1; list-style: none; padding: 20px 0; }
        .sidebar-nav a { display: block; padding: 15px 20px; color: #ecf0f1; text-decoration: none; transition: background-color 0.2s; }
        .sidebar-nav a:hover, .sidebar-nav a.active { background-color: #34495e; }
        .sidebar-footer { padding: 20px; }
        .logout-btn { width: 100%; padding: 12px; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .main-content { margin-left: 0; padding: 20px; transition: margin-left 0.3s ease; }
        .main-content.shifted { margin-left: 250px; }
        .header { display: flex; align-items: center; margin-bottom: 30px; background: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .menu-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; margin-right: 20px; padding: 5px; }
        .calendar-container { max-width: 1400px; margin: 0 auto; }
        .calendar-header { background: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .calendar-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .nav-buttons { display: flex; gap: 10px; }
        .btn { padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s ease; }
        .btn:hover { background: #2980b9; transform: translateY(-1px); }
        .btn-success { background: #2ecc71; }
        .btn-success:hover { background: #27ae60; }
        .btn-sm { padding: 8px 16px; font-size: 12px; }
        .current-month { font-size: 1.8rem; font-weight: 700; color: #2c3e50; }
        .view-buttons { display: flex; gap: 5px; background: #ecf0f1; border-radius: 8px; padding: 5px; }
        .view-btn { padding: 8px 16px; background: transparent; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; }
        .view-btn.active { background: #3498db; color: white; }
        .calendar-wrapper { display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        .calendar-main { background: white; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #dee2e6; }
        .calendar-day-header { background: #34495e; color: white; padding: 15px; text-align: center; font-weight: 600; font-size: 0.9rem; }
        .calendar-day { background: white; min-height: 120px; padding: 8px; position: relative; cursor: pointer; transition: all 0.3s ease; }
        .calendar-day:hover { background: #f8f9fa; }
        .calendar-day.other-month { background: #f8f9fa; color: #95a5a6; }
        .calendar-day.today { background: #e7f3ff; border: 2px solid #3498db; }
        .calendar-day.has-events { background: #fff3cd; }
        .calendar-day.past-day { background: #f8f9fa; cursor: pointer; }
        .calendar-day.past-day:hover { background: #e9ecef; }
        .day-number { font-weight: 600; font-size: 1rem; margin-bottom: 5px; color: #2c3e50; }
        .other-month .day-number { color: #95a5a6; }
        .past-day .day-number { color: #7f8c8d; }
        .events-container { display: flex; flex-direction: column; gap: 2px; max-height: 80px; overflow-y: auto; }
        .event-preview { background: rgba(52, 152, 219, 0.1); border-left: 3px solid #3498db; padding: 4px 6px; border-radius: 0 4px 4px 0; font-size: 0.7rem; margin-bottom: 2px; color: #2c3e50; font-weight: 500; }
        .event-preview.class { background: rgba(52, 152, 219, 0.1); border-left-color: #3498db; }
        .event-preview.exam { background: rgba(231, 76, 60, 0.1); border-left-color: #e74c3c; }
        .event-preview.assignment { background: rgba(243, 156, 18, 0.1); border-left-color: #f39c12; }
        .event-preview.personal { background: rgba(155, 89, 182, 0.1); border-left-color: #9b59b6; }
        .event-preview.study { background: rgba(46, 204, 113, 0.1); border-left-color: #2ecc71; }
        .event-preview.meeting { background: rgba(26, 188, 156, 0.1); border-left-color: #1abc9c; }
        .more-events { color: #7f8c8d; font-size: 0.7rem; font-style: italic; text-align: center; }
        .calendar-sidebar { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); height: fit-content; max-height: 600px; overflow-y: auto; }
        .sidebar-title { color: #2c3e50; font-size: 1.2rem; font-weight: 600; margin-bottom: 20px; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; }
        .event-item { background: #f8f9fa; border-left: 4px solid #3498db; padding: 12px; margin-bottom: 10px; border-radius: 0 8px 8px 0; transition: all 0.3s ease; }
        .event-item:hover { background: #e9ecef; transform: translateX(2px); }
        .event-item.class { border-left-color: #3498db; }
        .event-item.exam { border-left-color: #e74c3c; }
        .event-item.assignment { border-left-color: #f39c12; }
        .event-item.personal { border-left-color: #9b59b6; }
        .event-item.study { border-left-color: #2ecc71; }
        .event-item.meeting { border-left-color: #1abc9c; }
        .event-time { font-weight: 600; color: #2c3e50; font-size: 0.9rem; margin-bottom: 5px; }
        .event-title { color: #495057; font-size: 0.9rem; margin-bottom: 5px; }
        .event-type { display: inline-block; background: #e9ecef; color: #6c757d; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 500; }
        .quick-actions { margin-top: 30px; }
        .quick-action-btn { width: 100%; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 10000; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #ecf0f1; padding-bottom: 15px; }
        .modal-header h2 { color: #2c3e50; font-size: 1.5rem; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #7f8c8d; padding: 5px; }
        .modal-close:hover { color: #e74c3c; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 14px; transition: border-color 0.3s ease; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #3498db; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-footer { display: flex; gap: 15px; margin-top: 25px; }
        .event-list { max-height: 400px; overflow-y: auto; }
        .event-card { background: #f8f9fa; border: 2px solid #ecf0f1; border-radius: 10px; padding: 15px; margin-bottom: 15px; transition: all 0.3s ease; }
        .event-card:hover { border-color: #3498db; }
        .event-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .event-card-title { font-weight: 600; color: #2c3e50; }
        .event-card-actions { display: flex; gap: 8px; }
        .action-btn { padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .edit-btn { background: #3498db; color: white; }
        .delete-btn { background: #e74c3c; color: white; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .overlay.active { opacity: 1; visibility: visible; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; background: #2ecc71; color: white; border-radius: 8px; z-index: 10000; animation: slideIn 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @media (max-width: 768px) { .main-content.shifted { margin-left: 0; } .calendar-wrapper { grid-template-columns: 1fr; } .calendar-sidebar { order: -1; margin-bottom: 20px; } .form-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header"><h2>üìö Student Hub</h2></div>
        <nav>
            <ul class="sidebar-nav">
                <li><a href="dashboard.html">üè† Dashboard</a></li>
                <li><a href="profile.html">üë§ Profile</a></li>
                <li><a href="goals.html">üéØ Goals</a></li>
                <li><a href="calendar.html" class="active">üìÖ Calendar</a></li>
                <li><a href="history.html">üìú History</a></li>
                <li><a href="analysis.html">üìä Analysis</a></li>
                <li><a href="ai-tracking.html">ü§ñ AI Tracking</a></li>
            </ul>
        </nav>
        <div class="sidebar-footer"><button class="logout-btn" onclick="logout()">Logout</button></div>
    </div>
    <div class="overlay" id="overlay"></div>
    <div class="main-content" id="main-content">
        <div class="header"><button class="menu-btn" onclick="toggleMenu()">‚ò∞</button><h1>Calendar</h1></div>
        <div class="calendar-container">
            <div class="calendar-header">
                <div class="calendar-nav">
                    <div class="nav-buttons">
                        <button class="btn btn-sm" onclick="previousMonth()">‚óÄ Previous</button>
                        <button class="btn btn-sm" onclick="goToToday()">Today</button>
                        <button class="btn btn-sm" onclick="nextMonth()">Next ‚ñ∂</button>
                    </div>
                    <div class="current-month" id="current-month">January 2024</div>
                </div>
                <div style="text-align: center;"><button class="btn btn-success" onclick="openEventModal()">+ Add Event</button></div>
            </div>
            <div class="calendar-wrapper">
                <div class="calendar-main">
                    <div class="calendar-grid">
                        <div class="calendar-day-header">Sun</div><div class="calendar-day-header">Mon</div><div class="calendar-day-header">Tue</div><div class="calendar-day-header">Wed</div><div class="calendar-day-header">Thu</div><div class="calendar-day-header">Fri</div><div class="calendar-day-header">Sat</div>
                    </div>
                    <div class="calendar-grid" id="calendar-days"></div>
                </div>
                <div class="calendar-sidebar">
                    <h3 class="sidebar-title">Today's Schedule</h3>
                    <div class="today-events" id="today-events"></div>
                    <div class="quick-actions">
                        <h4 class="sidebar-title">Quick Actions</h4>
                        <button class="btn btn-sm btn-success quick-action-btn" onclick="addQuickEvent('class')">üìö Add Class</button>
                        <button class="btn btn-sm btn-success quick-action-btn" onclick="addQuickEvent('study')">üìñ Study Session</button>
                        <button class="btn btn-sm btn-success quick-action-btn" onclick="addQuickEvent('exam')">üìù Add Exam</button>
                        <button class="btn btn-sm btn-success quick-action-btn" onclick="addQuickEvent('assignment')">üìã Assignment Due</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" id="event-modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="event-modal-title">Add New Event</h2><button class="modal-close" onclick="closeEventModal()">‚úï</button></div>
            <form id="event-form">
                <div class="form-group"><label for="event-title">Event Title</label><input type="text" id="event-title" required placeholder="Enter event title"></div>
                <div class="form-row"><div class="form-group"><label for="event-date">Date</label><input type="date" id="event-date" required></div><div class="form-group"><label for="event-time">Time</label><input type="time" id="event-time" required></div></div>
                <div class="form-row"><div class="form-group"><label for="event-type">Event Type</label><select id="event-type" required><option value="class">Class</option><option value="exam">Exam</option><option value="assignment">Assignment Due</option><option value="study">Study Session</option><option value="meeting">Meeting</option><option value="personal">Personal</option></select></div><div class="form-group"><label for="event-duration">Duration (minutes)</label><input type="number" id="event-duration" min="15" max="480" value="60"></div></div>
                <div class="form-group"><label for="event-description">Description (Optional)</label><textarea id="event-description" rows="3" placeholder="Event details..."></textarea></div>
                <div class="form-group"><label for="event-location">Location (Optional)</label><input type="text" id="event-location" placeholder="Event location..."></div>
                <div class="form-footer"><button type="button" class="btn" onclick="closeEventModal()">Cancel</button><button type="submit" class="btn btn-success" id="event-submit-btn">Add Event</button></div>
            </form>
        </div>
    </div>
    <div class="modal" id="events-list-modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="events-list-title">Events</h2><button class="modal-close" onclick="closeEventsListModal()">‚úï</button></div>
            <div class="event-list" id="events-list"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBZSn_K2V_QJWM6WoMSb_dtFHIZpP_UAcI",
            authDomain: "student-organizer-53420.firebaseapp.com",
            projectId: "student-organizer-53420",
            storageBucket: "student-organizer-53420.firebasestorage.app",
            messagingSenderId: "481845921136",
            appId: "1:481845921136:web:10ce801027f42b2311bbb5",
            measurementId: "G-7365W6G880"
        };

        let auth, db, currentUser;
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            console.log('‚úÖ Firebase initialized successfully');
        } catch (error) {
            console.error('‚ùå Firebase init error:', error);
        }

        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let events = [];
        let classSchedules = {};
        let editingEventId = null;
        const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
        const dayNames = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];

        function escapeHtml(text) { if (!text) return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        
        function getLocalDateString(year, month, day) {
            // Create date string in YYYY-MM-DD format without timezone conversion
            // month parameter is 0-indexed (0=Jan, 11=Dec), so add 1 for the string
            const m = String(month + 1).padStart(2, '0');
            const d = String(day).padStart(2, '0');
            const result = `${year}-${m}-${d}`;
            console.log(`getLocalDateString(${year}, ${month}, ${day}) = ${result}`);
            return result;
        }
        
        function isPastDate(dateStr) {
            // Use local date comparison to avoid timezone issues
            const dateParts = dateStr.split('-');
            const date = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
            const today = new Date();
            
            // Set both to start of day for fair comparison
            today.setHours(0, 0, 0, 0);
            date.setHours(0, 0, 0, 0);
            
            console.log('isPastDate check:', {
                dateStr: dateStr,
                parsedDate: date,
                today: today,
                isPast: date < today
            });
            
            // Return true only if date is BEFORE today (not equal to today)
            return date < today;
        }

        document.addEventListener('DOMContentLoaded', function() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    console.log('‚úÖ User logged in:', user.email);
                    
                    // Debug: Check what date we're working with
                    const now = new Date();
                    console.log('Current Date Object:', now);
                    console.log('Year:', now.getFullYear(), 'Month:', now.getMonth(), 'Day:', now.getDate());
                    console.log('Local Date String:', getLocalDateString(now.getFullYear(), now.getMonth(), now.getDate()));
                    
                    loadAllData();
                } else {
                    console.log('‚ùå No user logged in, redirecting...');
                    window.location.href = 'index.html';
                }
            });
        });

        async function loadAllData() {
            await loadEvents();
            await loadClassSchedules();
            renderCalendar();
            updateTodayEvents();
        }

        async function loadEvents() {
            if (!currentUser) return;
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('events').get();
                events = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log('‚úÖ Loaded events:', events.length);
            } catch (error) {
                console.error('‚ùå Error loading events:', error);
            }
        }

        async function loadClassSchedules() {
            if (!currentUser) return;
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('dailyData').get();
                
                classSchedules = {};
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.trackers && data.trackers.schedule) {
                        classSchedules[doc.id] = data.trackers.schedule;
                    }
                });
                console.log('‚úÖ Loaded class schedules for', Object.keys(classSchedules).length, 'days');
            } catch (error) {
                console.error('‚ùå Error loading class schedules:', error);
            }
        }

        function toggleMenu() { 
            document.getElementById('sidebar').classList.toggle('active'); 
            document.getElementById('overlay').classList.toggle('active'); 
            document.getElementById('main-content').classList.toggle('shifted'); 
        }
        
        async function logout() { 
            if (confirm('Are you sure you want to logout?')) { 
                try {
                    await auth.signOut();
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('Error logging out. Please try again.');
                }
            } 
        }

        function renderCalendar() {
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();
            document.getElementById('current-month').textContent = `${monthNames[currentMonth]} ${currentYear}`;
            const calendarDays = document.getElementById('calendar-days');
            calendarDays.innerHTML = '';
            const today = new Date();
            let dayCounter = 1;
            
            for (let i = firstDay - 1; i >= 0; i--) {
                const prevMonthDate = new Date(currentYear, currentMonth - 1, daysInPrevMonth - i);
                const dateStr = getLocalDateString(
                        prevMonthDate.getFullYear(),
                        prevMonthDate.getMonth(),
                        prevMonthDate.getDate()
                );

                calendarDays.appendChild(createCalendarDay(daysInPrevMonth - i, true, false, dateStr));
            }
            
            for (let i = 1; i <= daysInMonth; i++) { 
                const currentDate = new Date(currentYear, currentMonth, i);
                const dateStr = getLocalDateString(currentYear, currentMonth, i);

                const isToday = currentYear === today.getFullYear() && currentMonth === today.getMonth() && i === today.getDate();
                calendarDays.appendChild(createCalendarDay(i, false, isToday, dateStr)); 
                dayCounter++; 
            }
            
            let nextMonthDay = 1;
            while (dayCounter <= 42) { 
                const nextMonthDate = new Date(currentYear, currentMonth + 1, nextMonthDay);
                const dateStr = getLocalDateString(
    nextMonthDate.getFullYear(),
    nextMonthDate.getMonth(),
    nextMonthDate.getDate()
);

                calendarDays.appendChild(createCalendarDay(nextMonthDay, true, false, dateStr)); 
                dayCounter++;
                nextMonthDay++;
            }
        }

        function createCalendarDay(day, isOtherMonth, isToday = false, dateStr) {
            const dayDiv = document.createElement('div');
            
            // Only mark as past if it's actually before today (not including today)
            const isPast = !isToday && isPastDate(dateStr);
            
            dayDiv.className = `calendar-day ${isOtherMonth ? 'other-month' : ''} ${isToday ? 'today' : ''} ${isPast ? 'past-day' : ''}`;
            
            const dayEvents = events.filter(e => e.date === dateStr);
            const hasSchedule = classSchedules[dateStr];
            
            if (dayEvents.length > 0 || hasSchedule) dayDiv.classList.add('has-events');
            dayDiv.innerHTML = `<div class="day-number">${day}</div>${renderDayEvents(dayEvents, dateStr)}`;
            
            if (!isOtherMonth) {
                dayDiv.addEventListener('click', () => showDayEvents(dateStr, day, isPast));
            }
            
            return dayDiv;
        }

        function renderDayEvents(dayEvents, dateStr) {
            const allEvents = [...dayEvents];
            
            console.log('renderDayEvents for date:', dateStr);
            console.log('Has schedule for this date?', classSchedules[dateStr]);
            
            // Add class schedule as events
            if (classSchedules[dateStr]) {
                const scheduleLines = classSchedules[dateStr].split('\n').filter(line => line.trim());
                console.log('Found schedule lines:', scheduleLines);
                scheduleLines.forEach(line => {
                    const parts = line.split(' - ');
                    allEvents.push({
                        title: parts[1] || line,
                        time: parts[0] || '',
                        type: 'class',
                        isSchedule: true
                    });
                });
            }
            
            if (allEvents.length === 0) return '';
            
            let html = '<div class="events-container">';
            if (allEvents.length <= 3) { 
                allEvents.forEach(ev => { 
                    html += `<div class="event-preview ${escapeHtml(ev.type)}">${escapeHtml(ev.title)}</div>`; 
                }); 
            } else { 
                allEvents.slice(0, 2).forEach(ev => { 
                    html += `<div class="event-preview ${escapeHtml(ev.type)}">${escapeHtml(ev.title)}</div>`; 
                }); 
                html += `<div class="more-events">+${allEvents.length - 2} more</div>`; 
            }
            return html + '</div>';
        }

        function showDayEvents(dateStr, day, isPast = false) {
            console.log('=== showDayEvents Debug ===');
            console.log('dateStr passed:', dateStr);
            console.log('day number passed:', day);
            
            const dayEvents = events.filter(e => e.date === dateStr);
            const hasSchedule = classSchedules[dateStr];
            
            if (dayEvents.length === 0 && !hasSchedule) { 
                if (isPast) {
                    showNotification('No events on this past date. Cannot add new events to past dates.', 'error');
                } else if (confirm(`No events on ${day}. Would you like to add one?`)) {
                    openEventModal(dateStr);
                }
                return; 
            }
            
            // Parse date without timezone issues
            const dateParts = dateStr.split('-');
            console.log('Date parts:', dateParts);
            const dateObj = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
            console.log('Created date object:', dateObj);
            console.log('Day of week:', dateObj.getDay());
            
            const dayOfWeek = dayNames[dateObj.getDay()];
            const formattedDate = dateObj.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            
            console.log('Day of week name:', dayOfWeek);
            console.log('Formatted date:', formattedDate);
            console.log('Final title:', `Events for ${dayOfWeek}, ${formattedDate}`);
            
            document.getElementById('events-list-title').textContent = `Events for ${dayOfWeek}, ${formattedDate}${isPast ? ' (Read Only)' : ''}`;
            
            let eventsHTML = '';
            
            // Add class schedule
            if (hasSchedule) {
                const scheduleLines = classSchedules[dateStr].split('\n').filter(line => line.trim());
                scheduleLines.forEach(line => {
                    const parts = line.split(' - ');
                    eventsHTML += `
                        <div class="event-card class">
                            <div class="event-card-header">
                                <div class="event-card-title">${escapeHtml(parts[1] || line)}</div>
                                <span style="color:#7f8c8d;font-size:0.8rem;">üìö Class Schedule</span>
                            </div>
                            <div style="font-size:0.9rem;color:#7f8c8d;">${escapeHtml(parts[0] || '')} ‚Ä¢ Class</div>
                        </div>`;
                });
            }
            
            // Add regular events
            dayEvents.forEach(ev => {
                eventsHTML += `
                    <div class="event-card ${escapeHtml(ev.type)}">
                        <div class="event-card-header">
                            <div class="event-card-title">${escapeHtml(ev.title)}</div>
                            ${!isPast ? `<div class="event-card-actions"><button class="action-btn edit-btn" onclick="editEvent('${escapeHtml(ev.id)}')">Edit</button><button class="action-btn delete-btn" onclick="deleteEvent('${escapeHtml(ev.id)}')">Delete</button></div>` : '<span style="color:#7f8c8d;font-size:0.8rem;">Past Event</span>'}
                        </div>
                        <div style="font-size:0.9rem;color:#7f8c8d;margin-bottom:5px;">${escapeHtml(ev.time)} ‚Ä¢ ${escapeHtml(ev.type.charAt(0).toUpperCase() + ev.type.slice(1))}${ev.duration ? ` ‚Ä¢ ${escapeHtml(ev.duration)} min` : ''}</div>
                        ${ev.description ? `<div style="font-size:0.9rem;margin-bottom:5px;">${escapeHtml(ev.description)}</div>` : ''}
                        ${ev.location ? `<div style="font-size:0.8rem;color:#95a5a6;">üìç ${escapeHtml(ev.location)}</div>` : ''}
                    </div>`;
            });
            
            document.getElementById('events-list').innerHTML = eventsHTML;
            document.getElementById('events-list-modal').classList.add('active');
        }

        function previousMonth() { currentMonth--; if (currentMonth < 0) { currentMonth = 11; currentYear--; } renderCalendar(); }
        function nextMonth() { currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentYear++; } renderCalendar(); }
        function goToToday() { const today = new Date(); currentMonth = today.getMonth(); currentYear = today.getFullYear(); renderCalendar(); }

        function openEventModal(dateStr = null) {
            if (dateStr && isPastDate(dateStr)) {
                showNotification('Cannot add events to past dates', 'error');
                return;
            }
            
            editingEventId = null;
            document.getElementById('event-modal-title').textContent = 'Add New Event';
            document.getElementById('event-submit-btn').textContent = 'Add Event';
            document.getElementById('event-form').reset();
            
            const today = new Date();
            const todayStr = getLocalDateString(today.getFullYear(), today.getMonth(), today.getDate());
            document.getElementById('event-date').value = dateStr || todayStr;
            document.getElementById('event-date').min = todayStr;
            
            document.getElementById('event-modal').classList.add('active');
        }

        function closeEventModal() { document.getElementById('event-modal').classList.remove('active'); editingEventId = null; }
        function closeEventsListModal() { document.getElementById('events-list-modal').classList.remove('active'); }

        async function handleEventSubmit(e) {
            e.preventDefault();
            
            const eventDate = document.getElementById('event-date').value;
            
            if (isPastDate(eventDate) && !editingEventId) {
                showNotification('Cannot add events to past dates', 'error');
                return;
            }
            
            const eventData = { 
                title: document.getElementById('event-title').value, 
                date: eventDate, 
                time: document.getElementById('event-time').value, 
                type: document.getElementById('event-type').value, 
                duration: document.getElementById('event-duration').value, 
                description: document.getElementById('event-description').value, 
                location: document.getElementById('event-location').value, 
                createdAt: new Date().toISOString() 
            };
            
            try {
                if (editingEventId) { 
                    await db.collection('users').doc(currentUser.uid)
                        .collection('events').doc(editingEventId).update(eventData);
                    const idx = events.findIndex(e => e.id === editingEventId); 
                    if (idx !== -1) events[idx] = { id: editingEventId, ...eventData };
                } else { 
                    const docRef = await db.collection('users').doc(currentUser.uid)
                        .collection('events').add(eventData);
                    events.push({ id: docRef.id, ...eventData }); 
                }
                
                renderCalendar(); 
                updateTodayEvents(); 
                closeEventModal();
                showNotification(`Event ${editingEventId ? 'updated' : 'added'} successfully!`, 'success');
                editingEventId = null;
            } catch (error) {
                console.error('Error saving event:', error);
                showNotification('Error saving event. Please try again.', 'error');
            }
        }

        async function editEvent(eventId) {
            const ev = events.find(e => e.id === eventId); 
            if (!ev) return;
            
            editingEventId = eventId;
            document.getElementById('event-modal-title').textContent = 'Edit Event';
            document.getElementById('event-submit-btn').textContent = 'Update Event';
            document.getElementById('event-title').value = ev.title;
            document.getElementById('event-date').value = ev.date;
            document.getElementById('event-time').value = ev.time;
            document.getElementById('event-type').value = ev.type;
            document.getElementById('event-duration').value = ev.duration || '60';
            document.getElementById('event-description').value = ev.description || '';
            document.getElementById('event-location').value = ev.location || '';
            
            const today = new Date();
            const todayStr = getLocalDateString(today.getFullYear(), today.getMonth(), today.getDate());
            document.getElementById('event-date').min = todayStr;
            
            closeEventsListModal(); 
            document.getElementById('event-modal').classList.add('active');
        }

        async function deleteEvent(eventId) {
            if (!confirm('Are you sure you want to delete this event?')) return;
            
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('events').doc(eventId).delete();
                events = events.filter(e => e.id !== eventId);
                renderCalendar(); 
                updateTodayEvents(); 
                closeEventsListModal();
                showNotification('Event deleted successfully!', 'success');
            } catch (error) {
                console.error('Error deleting event:', error);
                showNotification('Error deleting event. Please try again.', 'error');
            }
        }

        async function addQuickEvent(type) {
            const typeTitles = { 
                class: 'New Class', 
                exam: 'Upcoming Exam', 
                assignment: 'Assignment Due', 
                study: 'Study Session', 
                meeting: 'Meeting', 
                personal: 'Personal Task' 
            };
            
            const title = prompt(`Enter ${typeTitles[type] || 'event'} title:`, typeTitles[type]);
            if (!title) return;
            
            const today = new Date();
            const todayStr = getLocalDateString(today.getFullYear(), today.getMonth(), today.getDate());
            const eventData = { 
                title: title, 
                date: todayStr, 
                time: type === 'class' ? '09:00' : '14:00', 
                type: type, 
                duration: type === 'class' ? '60' : '30', 
                description: '', 
                location: '', 
                createdAt: new Date().toISOString() 
            };
            
            try {
                const docRef = await db.collection('users').doc(currentUser.uid)
                    .collection('events').add(eventData);
                events.push({ id: docRef.id, ...eventData }); 
                renderCalendar(); 
                updateTodayEvents();
                showNotification(`${typeTitles[type] || 'Event'} added successfully!`, 'success');
            } catch (error) {
                console.error('Error adding quick event:', error);
                showNotification('Error adding event. Please try again.', 'error');
            }
        }

        async function updateTodayEvents() {
            const today = new Date();
            const todayStr = getLocalDateString(today.getFullYear(), today.getMonth(), today.getDate());
            const todayEvents = events.filter(e => e.date === todayStr);
            const todaySchedule = classSchedules[todayStr];
            const container = document.getElementById('today-events');
            
            let html = '';
            
            // Add class schedule first
            if (todaySchedule) {
                const lines = todaySchedule.split('\n').filter(line => line.trim());
                lines.forEach(line => { 
                    const parts = line.split(' - '); 
                    html += `<div class="event-item class"><div class="event-time">${escapeHtml(parts[0] || '')}</div><div class="event-title">${escapeHtml(parts[1] || line)}</div><div class="event-type">Class Schedule</div></div>`; 
                });
            }
            
            // Add regular events
            todayEvents.sort((a, b) => a.time.localeCompare(b.time)).forEach(ev => {
                html += `<div class="event-item ${escapeHtml(ev.type)}"><div class="event-time">${escapeHtml(ev.time)}</div><div class="event-title">${escapeHtml(ev.title)}</div><div class="event-type">${escapeHtml(ev.type.charAt(0).toUpperCase() + ev.type.slice(1))}</div></div>`;
            });
            
            if (html === '') { 
                container.innerHTML = '<p style="color:#7f8c8d;text-align:center;padding:20px;">No events scheduled for today</p>'; 
            } else {
                container.innerHTML = html;
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div'); 
            notification.className = 'notification'; 
            notification.textContent = message;
            notification.style.background = type === 'error' ? '#e74c3c' : type === 'success' ? '#2ecc71' : '#3498db';
            document.body.appendChild(notification); 
            setTimeout(() => notification.remove(), 3000);
        }

        document.getElementById('event-form').addEventListener('submit', handleEventSubmit);
        document.getElementById('event-modal').addEventListener('click', function(e) { if (e.target === this) closeEventModal(); });
        document.getElementById('events-list-modal').addEventListener('click', function(e) { if (e.target === this) closeEventsListModal(); });
        document.getElementById('overlay').addEventListener('click', toggleMenu);

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') { 
                if (document.getElementById('event-modal').classList.contains('active')) closeEventModal(); 
                else if (document.getElementById('events-list-modal').classList.contains('active')) closeEventsListModal(); 
                else if (document.getElementById('sidebar').classList.contains('active')) toggleMenu(); 
            }
            if (e.ctrlKey && e.key === 'n') { e.preventDefault(); openEventModal(); }
        });
    </script>
</body>
</html>